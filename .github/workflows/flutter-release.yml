name: Build & Release Flutter Multiplatform

on:
  workflow_dispatch:
    inputs:
      build_macos:
        description: 'Build macOS desktop'
        type: boolean
        default: true
      build_ios:
        description: 'Build iOS (.ipa)'
        type: boolean
        default: true
      build_windows:
        description: 'Build Windows'
        type: boolean
        default: true
      build_android:
        description: 'Build Android (APK + AAB)'
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux'
        type: boolean
        default: true
      build_web:
        description: 'Build Web'
        type: boolean
        default: true
      flutter_channel:
        description: 'Flutter channel'
        type: choice
        options: [stable, beta, master]
        default: stable
      release_tag:
        description: 'Release tag (e.g. v1.5.0)'
        type: string
        required: true
        default: v${{ github.run_number }}

env:
  RELEASE_TAG: ${{ inputs.release_tag }}

jobs:
  # ====================== macOS + iOS ======================
  build-macos-ios:
    name: macOS & iOS
    if: ${{ inputs.build_macos || inputs.build_ios }}
    runs-on: macos-14
    outputs:
      macos_zip: ${{ steps.package.outputs.macos_zip }}
      ios_ipa: ${{ steps.package.outputs.ios_ipa }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: '17' }

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ inputs.flutter_channel }}
          cache: true

      - name: Enable platforms & pub get
        run: |
          flutter config --enable-macos-desktop --enable-ios
          flutter pub get

      - name: Build macOS
        if: inputs.build_macos
        run: flutter build macos --release

      - name: Build iOS IPA
        if: inputs.build_ios
        run: flutter build ipa --release

      - name: Package artifacts
        id: package
        run: |
          if [ "${{ inputs.build_macos }}" = "true" ]; then
            cd build/macos/Build/Products/Release
            zip -r9 ${{ github.workspace }}/MyApp-macOS-${{ env.RELEASE_TAG }}.zip *.app
            echo "macos_zip=MyApp-macOS-${{ env.RELEASE_TAG }}.zip" >> $GITHUB_OUTPUT
          fi
          
          if [ "${{ inputs.build_ios }}" = "true" ]; then
            echo "ios_ipa=$(find build/ios/ipa -name "*.ipa" | head -1)" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifacts (临时保存)
        uses: actions/upload-artifact@v4
        with:
          name: macos-ios-artifacts
          path: |
            ${{ github.workspace }}/*.zip
            ${{ steps.package.outputs.ios_ipa }}

  # ====================== Windows ======================
  build-windows:
    name: Windows
    if: inputs.build_windows
    runs-on: windows-latest
    outputs:
      windows_zip: ${{ steps.package.outputs.windows_zip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ inputs.flutter_channel }}
          cache: true

      - name: Enable & pub get
        run: |
          flutter config --enable-windows-desktop
          flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Package Windows
        id: package
        shell: bash
        run: |
          cd build/windows/x64/runner/Release
          zip -r9 ${{ github.workspace }}/MyApp-Windows-${{ env.RELEASE_TAG }}.zip . -x "*.ilk" "*.exp" "*.lib" "*.pdb"
          echo "windows_zip=MyApp-Windows-${{ env.RELEASE_TAG }}.zip" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifact
          path: ${{ github.workspace }}/*.zip

  # ====================== Linux ======================
  build-linux:
    name: Linux
    if: inputs.build_linux
    runs-on: ubuntu-latest
    outputs:
      linux_zip: ${{ steps.package.outputs.linux_zip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with: { channel: ${{ inputs.flutter_channel }}, cache: true }

      - name: Build Linux
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
          flutter build linux --release

      - name: Package Linux
        id: package
        run: |
          cd build/linux/x64/release/bundle
          zip -r9 ${{ github.workspace }}/MyApp-Linux-${{ env.RELEASE_TAG }}.zip .
          echo "linux_zip=MyApp-Linux-${{ env.RELEASE_TAG }}.zip" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifact
          path: ${{ github.workspace }}/*.zip

  # ====================== Android + Web ======================
  build-android-web:
    name: Android & Web
    if: ${{ inputs.build_android || inputs.build_web }}
    runs-on: ubuntu-latest
    outputs:
      apk_path: ${{ steps.package.outputs.apk }}
      aab_path: ${{ steps.package.outputs.aab }}
      web_zip: ${{ steps.package.outputs.web_zip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        if: inputs.build_android
        uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: '17' }

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with: { channel: ${{ inputs.flutter_channel }}, cache: true }

      - name: Pub get
        run: flutter pub get

      - name: Build Android
        if: inputs.build_android
        run: |
          flutter build apk --release
          flutter build appbundle --release

      - name: Build Web
        if: inputs.build_web
        run: flutter build web --release --web-renderer canvaskit

      - name: Package Android & Web
        id: package
        run: |
          if [ "${{ inputs.build_android }}" = "true" ]; then
            echo "apk=build/app/outputs/flutter-apk/app-release.apk" >> $GITHUB_OUTPUT
            echo "aab=build/app/outputs/bundle/release/app-release.aab" >> $GITHUB_OUTPUT
          fi
          if [ "${{ inputs.build_web }}" = "true" ]; then
            cd build/web
            zip -r9 ${{ github.workspace }}/MyApp-Web-${{ env.RELEASE_TAG }}.zip .
            echo "web_zip=MyApp-Web-${{ env.RELEASE_TAG }}.zip" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-web-artifacts
          path: |
            build/app/outputs/**/*.apk
            build/app/outputs/**/*.aab
            ${{ github.workspace }}/*.zip

  # ====================== Create GitHub Release ======================
  create-release:
    name: Create GitHub Release
    needs: [build-macos-ios, build-windows, build-linux, build-android-web]
    runs-on: ubuntu-latest
    permissions:
      contents: write    # 必须要有创建 Release 的权限
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/macos-ios-artifacts/*.zip
            artifacts/macos-ios-artifacts/*.ipa
            artifacts/windows-artifact/*.zip
            artifacts/linux-artifact/*.zip
            artifacts/android-web-artifacts/*.apk
            artifacts/android-web-artifacts/*.aab
            artifacts/android-web-artifacts/*.zip
